[[collections]]
== Collections and Databases

A key value proposition of web sites is that they provide global access to persistent information. We typically store the persistent information in databases and files on a file system. Databases store the data as tables (or sometimes more complex structures, but for now, let's stick with tables).

A table is a set of rows, where each row has the same entries (the entry is called a column in the database). In OO design, you typically define an object that holds as its properties the entries within a row; so a table can be viewed as holding a collection of rows, or objects.

C# uses this model when it interacts with databases -- a query against a table returns a collection of objects; each property in a returned object maps to a column in the table or query.

=== Collections

C# has one built-in collection, the array. Arrays are fine, but consider what happens when you need to remove the second item in an array: if it's an array of objects, you can put a `null` there, but if it's a primitive, it has to have a value. If you wanted to "fill" the hole but maintain order, you would have to copy down all of the entries above, and then track that the array has one more entry empty at the end.  Collections are much richer: they do all of that management of entries for you, so you can add and remove entries as you need to. They can also maintain an order, based on the collection type: some maintain a sorted order, some maintain the order items were inserted.

An interesting feature that makes all of this possible is the generic class. A generic class lets you specialize a class when you use it, providing additional types used by that class. This lets you say what your collection holds; so you can specialize your collection to contain a particular type of object, rather than any object at all. This is similar to how you give an element type for your array when you declare it; that type is the only type allowed in the array (if it is a class, then instances of the class or of any of its subclasses are allowed).

==== Collection Interfaces

Although the implementations of collections provided in C# are classes, it defines interfaces for them as well. It is wise to use the interface on your variables, and restrict use of classes to the `new` statement. This lets you replace the chosen class with another one if you need to alter its performance or sort behavior. Collections' performance differ based on the types of operations you are performing or the type of sorting that is desired, if any.

[cols="1,4"]
|====
2+|The main Collection interfaces

|ICollection | the most general interface; it mainly defines Count, ToArray, and GetEnumerator
|IDictionary | a collection of key/value pairs; values can be accessed by keys . The Keys function on an IDictionary will return an ICollection containing just the keys.
|IList | a collection that can be accessed by a numeric index (like an array)
|====

There are two more interfaces in `System.Collections` which we make heavy use of: `IEnumerator` and `IEnumerable`. A class that implements `IEnumerator` will provide an `IEnumerable`. This is important because `IEnumerable` lets you not only move through the collection item by item, but also lets you access the collection's elements using a foreach loop. We say that the foreach loop enumerates through the items in the collection.

==== Collection Classes

The popular collection classes are:

[cols="1,1,3"]
|====
3+| Popular Collection classes

| ArrayList | IList | Items are ordered in the list. This looks alot like an array, but it lets you add and remove items dynamically (resizing the array). Sort and search capabilities are provided as well.
| Hashtable | IDictionary | Keys map to values, and you use keys to access the elements. The collection is not sorted; with a good hash function (which is used to assign storage locations), your data is dispersed in memory and both access and removal are quick.
| SortedList | IList & IDictionary | this allows both key and index access into a list; its entries when indexed contain both key and value. It is sorted on the key values.
| Stack | IList | the stack is a special type of list that only allows items to be pushed on top of the stack and taken off of the top of the stack. Knowing this is the main type of access lets the implementation focus on being fast for those accesses. It is often described as "Last In, First Out".
| Queue | IList | the queue is a special type of list as well; it only allows
items to be added at one end, and taken off of the other end. It is described as "First In, First Out".
|====

When you use these, or the interfaces, you can just use them "as-is", as they are fully-fledged classes. However, when you do that, it means the collection can contain any type of object at all; the default element type in the collection is object. And, boxing and unboxing means that primitives will get boxed up and stored in your collection as well.

==== Generic Collections

If you want to ensure that your collection contains only a particular type of object, you can do so by using a generic Collection type that permits adding a special type parameter to the class. This uses <> notation rather than a method's () notation for its parameters.

|====
| List<element-type> | a type-safe ArrayList, permits any instance of element-type or its subtypes
| Dictionary<key-type,value-type> | a type-safe Hashtable, permits any instance of the key-type or its subclasses for the key, and any instance of value-type or its subclasses for the value.
|====

So, an ArrayList can hold anything: ints (boxed), Cars, Pirates, even ArrayLists. But a List<Pirate> can hold only Pirates and instance of subclasses of Pirates.

When you want to ensure your collection contains only a particular type of objects, use the generic collections.  This ability is referred to as *generic classes*, since you create a new, specialized class when you provide the type parameters to it.

C# provides a way for you to create your own generic classes as well; however that is advanced programming, not covered in this text.

==== Example using collections

[source,java]
----
@using System.Collections.Generic;

... later in the page ...

@{
  IDictionary<string,int> phoneBook; // a map from strings to integers

  phoneBook = new Dictionary<string,int>();

  phoneBook.Add("Sarah Adams",1234567);
  phoneBook.Add("Jim Jones",5551212);
  phoneBook.Add("Nancy Smith",5010001);
  phoneBook.Add("Bill Blass",1237654);

  if (phoneBook.ContainsKey("Jim Jones")) {
    <p>Jim Jone's phone number is @phoneBook["Jim Jones"]</p>
  }
  else {
    <p>No phone number for Jim Jones.</p>
  }

  /// can also add items like so:
  phoneBook["Sam Sanders"] = 5051122;
  
  // this will also update an existing item:
  phoneBook["Nancy Smith"] = 5019999;
  
  ICollection<string> names = phoneBook.Keys;

  <p>Here is your current phone list:</p>
  foreach (string name in names) {
    // the key indexes into the dictionary to retrieve the value:
    <p>@name : @phoneBook[name]</p>
  }

}
----

=== Database Access

Today there are two popular database choices: Relational or NoSQL databases. For this text, our focus is a relational database. These databases store data in tables, which have rows and columns. You can query the database, selecting which rows you want from your tables and then which columns from the rows. You do this with the language SQL.

[NOTE]
====
This text assumes familiarity with SQL, so it will not introduce it to you, but will use it and provide descriptions of that use. We use Microsoft SQL Server Compact Edition through Visual Studio and IIS Express; applications developed in this manner transfer seamlessly to Microsoft SQL Server when deployed. But to deploy onto Oracle, MySQL, or some other database, you would need to adjust the connection mechanism and possibly the SQL syntax, as each database system has its own dialect of SQL.
====

Let's assume we have a contact list in our database with the following data:

|====
| Id | Name | PhoneNumber | Email | TwitterHandle

| 1 | Sarah Adams | 123-4567 | sarah@nowhere.com | @sarahnowhere
| 2 | Jim Jones | 555-1212 | jjones@gmail.com | @jjones3254
| 3 | Nancy Smith | 501-0001 | null | @flywitheagles
| 4 | Bill Blass | 123-7654 | bblass@bblass.net | @blassisback
|====

Note that we have an Id column; this is because good database design requires having a unique identifier (called a primary key) for each row. Name may not be good enough to be unique, if we have lots of contacts. Strings are slower in comparisons than integers, so we will usually see integers used as Id values.


In order to access a database, you first need to create one; in Visual Studio, in addition to IIS Express providing a local web server, SQL Server Express provides a local database server.

==== Create a Database

To create a database for your website, you must have it open in Visual Studio. If your website has an App_Data folder with a .sdf or .mdf file in it, then it already has a database; if you choose to use that one, jump ahead to "Create a Table".

If you do not have an App_Data directory in your project, right click in the Solution Explorer window on your web site/project name and click Add; in its menu click Add ASP.NET directory; and select App_Data from the list provided. You want to use this menu and not create it in the file system so that your project knows it exists.

Once you have an App_Data directory, right-click on that and click Add; then click Add New Item. In the dialog, under Installed>Visual C#, you should see "SQL Server database" in the list of choices. Select that, and then enter a name for your database (keep the .mdf file extension intact).

Once you are done, your database should appear under App_Data.

[NOTE]
====
If you are deploying to AppHarbor, or some other cloud ASP.NET PaaS, check to see if it allows more than one database. You may need to put all of your tables in a single database, rather than separate ones. This can be an issue if you are already using ASP.NET Identity, which assumes it can use a database named Identity with the connection name DefaultConnection.

You can add tables to the Identity database for your application's database functionality; it's just not the cleanest design to do so.
====

==== Database Configuration in Web.config

Your project Web.config file needs to have a connection string for your database. Check, and if it does not, add within the <connectionStrings> section of the file the following XML:

[source,xml]
----
  ... if tag not found, add this as a child of <configuration>, 
  ... after  <system.web>
  <connectionStrings>
    <add name="DatabaseName" connectionString="Data source=(LocalDB)\MSSQLLocalDB;|DataDirectory|\DatabaseName.mdf;Initial Catalog=DatabaseName;Integrated Security=true" providerName="System.Data.SqlClient"/>
    ... the rest of the element's children, if any
  </connectionStrings>
----

Replace DatabaseName in 3 places with the name you gave your database file. If you need to make this change, you will want to check that the setting in Tools->Options->Database Tools->Data Connections says `(LocalDB)\MSSQLLocalDB`. If you need to make either of these changes, exit and restart Visual Studio to ensure the changes are used when you access the database from within Visual Studio (before you create the table).

==== Create a Table

Creating a database is an administrative task that requires actions such as those done above; however, creating a table can be done by issuing an SQL statement. It's up to you, to do it manually or programmatically. If you code it, then you can re-run that code in the future to create the table again; if you do it manually, you will need to repeat the steps each time you want the table re-created. It is not uncommon for web developers to keep special pages for their website that will issue SQL commands to check or recreate the database.

===== Manual table creation

. Click on the "Server Explorer" tab to open it (it is under View if you do not have the tab visible already).
. If it is not open, click to open the list under "Data Connections". You should see your database there, click to expand its contents if it is not showing a list within it.
. Right-click on the Tables item (first in the list, usually) and click "Add New Table".
. This puts you in the table designer, where you can either create the table using the chart, defining each column and its type, or enter the SQL in the window at the bottom of the page.
+
Enter the following SQL to create our table:

[source,sql]
----
CREATE TABLE PhoneBook( 
  Id INT NOT NULL IDENTITY PRIMARY KEY,
  Name VARCHAR(50),
  PhoneNumber INT,
  Email VARCHAR(100),
  TwitterHandle VARCHAR(20)
  )
----

Click Update in the table design window. It will then ask if you want a Script before it does the update. Typically database administration involves keeping a collection of SQL commands in scripts to re-run them at a future date to update or repair a database. This is one such script. Since we have the command here, you can skip that and just click Update Database.

The log window will show if the database was successfully updated or not.

Once the table is created, you will need to right-click and click Refresh on your database name in the Server Explorer window for it to appear.


===== Code to create the table

The following Razor Page presents us with buttons; when clicked, they return us to the page and execute the specified SQL command.

.DBAdmin.cshtml
[source,html]
----
include::source/DBAdmin.cshtml[]
----

This is an interesting Razor example since it uses several features of Razor, C#,and HTML:

* @using -- to import the namespace that SQLException lives in
* try..catch -- so we can tell the user if something went wrong with the SQL command; note that returning stack traces is not good in live sites, you would want to protect this by requiring that the page only be used by administrators (see the next chapter for security information).
* we also used a finally block; it's important to free up the database connection when you are done with it, as it is holding onto quite a few system resources. If you don't explicitly close it, eventually the garbage collector will clean it up, but it's not a good idea to rely on that happening. We use a finally because it ensures the connection is closed no matter what exception was thrown.
* We use a special string value syntax, opening it with C#'s @",so that our long SQL command string can span lines in the file.
* The form has two submit buttons with the same name and different values; this is how the POST action can tell which button was clicked -- the value of the clicked button is the value of the buttons' name in the `Request.Form` dictionary.
* Notice if a form submission is manufactured with a bad choice, no command is run -- we don't even tell the user it was an invalid choice. This was a design decision, to give back minimal information to malicious users (since only spoofed POSTs could use bad values).

==== Put Data in the Table (INSERT)

Once you have a table, you need to be able to put data into it. If your table's data is static, you can do this through the Server Explorer view of the table in Visual Studio. If you right-click on the table in the Server Explorer view, you can see its data with the "Show Table Data" menu item. This shows you the data, and if you enter additional rows, they are saved to the table.

However, it is likely you will want to update your tables from your website; either as an administrative action or to let users share data with one another. You could request data directly from the user with a form, or you could collect the data more indirectly, such as a GPS location request or to save the results of a game they played in their browser.

[WARNING]
====
When passing user data to an SQL command, do not ever just concatenate a user string to
your SQL command. If you do, you open up your system to an *SQL Injection* attack, which can wreak havoc within your database system. For a hint at how to do this, see the XKCD comic usually referred to as https://xkcd.com/327/[Little Bobby Tables] (http://creativecommons.org/licenses/by-nc/2.5/[CC-BY-NC-2.5]):

image::images/exploits_of_a_mom.png[]

We will always use safe strings, either checking values or passing them through *dynamic parameters* to prevent SQL injection attacks.
====

In order to issue an INSERT command, we have to connect to the database, and then we can issue commands to it. Database connections use the connection name assigned in the Web.config file, so we make the connection like this:

[source,java]
----
var db = Database.Open("PhoneBookDB"); 
----

Notice we are just letting C# determine the type of the variable `db`; in fact it is a Database, which is a helper class in `WebMatrix.Data`, supplied to make direct database interactions available.

``PhoneBookDB`` is the name I gave this database in the Web.config file. It is usually the database name without the .mdf file extension.

Once you have a connection, you can issue an INSERT into a table that exists in that database. If the table does not exist, you will get an SQLException.  The INSERT needs to list the columns and then list its parameters in the same order. Here is an insert into our PhoneBookDB:

[source,java]
----
    var insertQuery = "INSERT INTO Product (Name, Description, Price) " +
                "VALUES (@0, @1, @2)";
    db.Execute(insertQuery, Name, Description, Price);
----

The @0, @1, and @2 are not Razor @'s, here they are SQL @'s, marking the parameters to the SQL statement. This protects against SQL injection because the values supplied are kept separate and not simply concatenated into the SQL string. 

[CAUTION]
====
Never, ever, ever, do this instead:

----
var insertQuery = "INSERT INTO Product (Name, Description, Price) " +
                "VALUES (\""+@Name+"\",\""+Description+"\","+@Price+")";
db.Execute(insertQuery);
----

Why not? because if Name came directly from a form field, it can contain malicious content that will take over the command and turn it into whatever SQL command the malicious user wants to make your database do, such as dropping all the tables or pulling out private data.
====

When you create your INSERT statement, you need to list all of the columns that you want to supply data for. If a column is not listed, then a SQL NULL value is put into that column in the new row.

Here is a page that will insert data into our table; note that if the form has no data, it is going to put in empty strings or 0's for numbers -- we really need validation on the values prior to this; you will see how to add validation in <<Validation and Helpers,Validation and Helpers>>.

.AddPhoneBookEntry.cshtml
[source,html]
----
include::source/AddPhoneBookEntry.cshtml[]
----

This is a very basic page; when the insert succeeds, the user is given a brief note, but if there is a problem, the page is replaced with an error page. There is almost no data validation -- all the code does is make sure SQL NULL values will be inserted when the form fields were left blank. It assumes the required field (name) will be present. We will see how to address this in a later chapter with the Validation helper.

[TIP]
====
Notice that we do not insert into the Id column -- because it was defined as an IDENTITY column, unique values will be automatically generated for us. Most SQL engines have this capability, though the syntax is often different.
====

We used the same `Execute` method that the CREATE TABLE and DROP TABLE statements used in our admin page, and could have used the same try..catch around it to determine what went wrong. Execute takes a variable number of parameters, so that you can specify the number to match all of the SQL parameters you have defined in your statement. If you specify fewer values than you have parameters, the Execute statement will throw an SQLException.

The database class has a useful method, `GetLastInsertId`, that you see used in the page.  Because we inserted into a table with an identity column, the database will give us back the value it generated for that column. We give it to the user (though usually you would not, but you might use it for some other, internal purpose).

==== View Data in the Table (SELECT, WebGrid)

Once you have data in your database, you will want to display it to the user. This means getting the data back out of the database. There are three methods on `Database`  that return data:

* `Query` -- for a SELECT statement that you expect to return any number of rows (including zero).
* `QuerySingle` -- for a SELECT statement that you expect to return exactly one row (just a single row)
* `QueryValue` -- for a SELECT statement that you expect to return exactly one column in one row (just a single value).

These methods all have the same parameters as `Execute`: the SELECT statement as a string, followed by any needed parameter values for parameters in the statement.

The Query method returns a collection as an `IEnumerable` -- it is typical to use a foreach loop on the query result, to generate an HTML table. Toward this end, there is a `WebGrid` helper which will transform your IEnumerable not only to a HTML table, but to one with multiple pages.

But let's explore that returned type, first. It is an IEnumerable of ... objects. C# transforms the row in the result to an anonymous object. Anonymous objects are objects created on the fly without an associated class. The row is transformed into an object by making each column value in it a property of the object. The property names are the SELECT column names -- so it's important to name expressions in your SELECT list, or understand how SQL Server names columns that are computed from expressions in SELECTs. If you look at the type of the variable of a row, you see it is `dynamic`. That means that the compiler doesn't know its type, and the runtime will only know it at the moment it gets created.

Let's generate our own table first, and then look at WebGrid.

.SelectTable.cshtml
[source,html]
----
include::source/SelectTable.cshtml[]
----

As you can see, we can dot off of our foreach variable row (which has the type dynamic) with the column names from our table. If you try to dot off of it with a different name, the compiler won't detect the error -- at runtime, you would get an exception.

The row is actually a `WebMatrix.Data.DynamicRecord`, and there are three different ways to access a given column:

. row.ColumnName as used in the code above
. row["ColumnName"]
. row[1] if ColumnName is column number 1 (remember, numbering starts at 0), returns that column

In addition to those access methods, `DyanmicRecord` provides the property `Columns`, which returns a list containing the column names. This can be useful if you do not know the names -- you can use that list to index into the rows with the column names, or to get the count of columns to use the integer indexing.  You can read more about `DynamicRecord` here: https://msdn.microsoft.com/en-us/library/webmatrix.data.dynamicrecord(v=vs.111).aspx.

==== WebGrid Helper

You could use the `DynamicRecord` ability to report column names and index the row columns to write your own helper that would generate an HTML table -- but you don't have to, since ASP.NET has done that. It has developed a very rich helper, `WebGrid`, which not only generates an HTML table, but provides paging so that long data results don't cause long pages.

Here is our example, changed to use WebGrid:

.SelectWebGrid.cshtml
[source,html]
----
include::source/SelectWebGrid.cshtml[]
----

As you can see, we create the `WebGrid` in a Razor code block, and then use its `GetHtml` method to generate the HTML for the Grid later on our page. When we use the `WebGrid` constructor, we supply:

* source: an IEnumerable (in fact, it doesn't even need to come from a query...)
* defaultSort: the column to sort the results on in the table
* rowsPerPage: how many rows to put in the table at a time

The WebGrid will generate an HTML table that lets you click back and forth between "pages" in the table. That switching is all done in the client, so there are no additional trips to the server.

To generate the HTML, call WebGrid's `GetHtml` method. This lets you specify:

* tableStyle: the class to put on the table; in the CSS of our example, you can see how we also applied it to the td's and th's within the table using CSS selectors.
* headerStyle: the class to put on the header row of the table.
* alternatingRowStyle: the class to put on alternating rows; this lets you shade every other row for more visual impact. If not specified, all rows are styled the same.
* columns: identify which columns of the result to display - you can include some or all, and put them in the order you want them to show up in the table.

You can rely on information from the database, and get a basic table, by passing just the SELECT result to WebGrid:
[source,HTML]
----
  var grid = new WebGrid(rows);
----
and then calling GetHtml with no styling options:
[source,HTML]
----
  @grid.GetHtml()
----
This displays all of the data returned in one table, with default table styling.


WebGrid is a very rich helper; as used here, it repeats the call whenever the next/previous page links are clicked. However, it has the ability to only update the table portion and not the whole page with a callback. This uses AJAX, Asynchronous Javascript And XML -- the link is turned into a JavaScript call that interacts with the server independently of the rest of the page, updating just the table to display the next (or previous) page of data.

// can't get this to work...
////
The most basic form of this requires adding one parameter to the WebGrid constructor call, to specify a container for the grid in the page; and then putting that id on the grid's `GetHtml` call (we do that below with a div element).

[source,java]
----
  var grid = new WebGrid(source: rows,  .., ajaxUpdateContainerId: "grid" );
----

[source,java]
----
  <div id="grid">
    @grid.GetHtml(..)
  </div>
----
////


To read more about this, see https://msdn.microsoft.com/en-us/library/system.web.helpers.webgrid(v=vs.111).aspx

==== Change Data in the Table (UPDATE and DELETE)

In addition to having data entered, you may wish to allow users to update or delete their data.

Good design is to have the user identify the row they wish to edit or delete, and then to write your code to use the primary key to identify the row in the database. The user should typically not see the keys when they are autogenerated, so you don't display them, but do track them in your code.

When requesting an update, you can either spend effort determining which values were changed by the user, or take the simpler route of assuming they've updated all of the columns. This works fine unless you have a very large column -- then knowing that it was or was not changed is good, since you save alot of space and time by not sending unchanged data back to the server.

A typical model for this is to present the user with a table of all of their data, and then let them choose a row to delete or update. This means that each row in the table has two operations; we could choose to make them links or buttons. Since I've given an multi-butotn example already, I will do this one with links.

.PhoneBookChoices.cshtml
[source,html]
----
include::source/PhoneBookChoices.cshtml[]
----

Notice the "extra" column in the `GetHtml` on the grid:

[source,html]
----
grid.Column("Id","Change",
            format: @<text>
                <a href="~/DeleteEntry?id=@item.Id">Delete</a>&nbsp;
                <a href="~/UpdateEntry?id=@item.Id">Update</a> </text>)
----

This column uses Id as its underlying value, but has its displayed column header say "Change". We don't want to display the Id, but we do want to use it in links. We do this by generating links directly in the format parameter. Notice that this is embedded HTML, not a string value, for the parameter.

The page link is useful, because it gives us the opportunity to confirm the change with the user; and since we pass in the id, we can fetch the record to display it to them before the confirm their change.

You may have noticed the added link below the table as well, to add a new entry. This links to our AddPhoneBookEntry.cshtml page, which does an insert, but does not link back to our page. ASP.NET gives us a way to make that happen automatically -- once AddPhoneBookEntry.cshtml completes an insert, it doesn't have to stay on its page. If we add this code after db.Close(), we will return to the PhoneBookChoices.cshtml page:

[source,html]
----
Response.Redirect("~/PhoneBookChoices");
----


Let's take a look at the delete operation, which also will use a redirect when it completes:

.DeleteEntry.cshtml
[source,html]
----
include::source/DeleteEntry.cshtml[]
----

You can see the redirect after a successful delete -- it returns us to the previous page; the cancel link at the bottom also does this, without making a delete. We keep the id value in the same place by making submit button use id as its name and the id value as its value. Alternatively, we could have made it a hidden field in our form.

This page should be more defensive; it makes these assumptions:

* that the id will find a row
* that a post will find a valid row
* that the delete will remove exactly 1 row, not 0 or more than 1 (since it's a primary key, the 'not more than one' is actually a fine assumption).

So we should expand the page to do these checks and inform the user appropriately if the delete request is no good.

The update operation is similar, but since we have to let the user change the data, we can use `QuerySingle` rather than `Query` to get the single row we are expecting. This time, we will code more defensively as well.

.UpdateEntry.cshtml
[source,html]
----
include::source/UpdateEntry.cshtml[]
----

As you can see, before we display data or make any changes, we validate that we got a row back from `QuerySingle`. If there is no row, we return to the list page (a quiet error) rather than let the user know they phished us, if they were malicious.

We also check the number of rows updated by looking at the value returned by Execute; up until now, we've been ignoring this value; but we can use it to code more defensively. On an Update, Insert, or Delete, it returns the number of rows affected by the statement.  In order for our Update to fail to find the 1 row, we'd need to have a very busy website with multiple users making changes at the same time -- so it is possible, but highly unlikely. I've coded a simple JavaScript alert but it would be more appropriate to say something like "please reissue request", or just bounce the user back to the home page to try again.

This collection of 4 pages: the list of entries, add, delete, and update lets us control the contents of our table. You will see this "CRUD" (create, update, delete) model again in ASP.NET MVC. These are the 4 basic operations on persistent storage; knowing how to do these 4 lets you then use the operations within other contexts to suit your application's needs.

==== Database class

We've used several methods of the Database class. Here is a list of its property and methods to review:

|====
| Static property |description

| Connection | the current connection
|====

|====
| Static methods | description

| Open(string) |	Opens a connection using the specified connection name or file name.
| OpenConnectionString(string) |	Opens a connection to a database using the specified connection string (these are like the values in our Web.config file).
| OpenConnectionString(String, String) |	Opens a connection to a database using a connection string and a provider.
|====

|====
|Method |description

| Close() |	Closes the database.
| Dispose() |	Releases all resources used by the database.
| Execute(string)	| Executes an SQL statement.
| Execute(string,object,..) | Executes an SQL statement with the specified values for its parameters.
| GetLastInsertId()	| Returns the generated identity column value of the most recently inserted row.
| Query |	Executes a SQL query that returns a list of rows as the result (as an IEnumerable); can specify parameter values
| QuerySingle	| Executes a SQL query that returns a single row as the result (as an anonymous object); can specify parameter values
| QueryValue	| Executes a SQL query that returns a single value as the result (as an object); can specify parameter values
|====

When using this class, it's important to remember to clean up. Otherwise, you may use up more system resources than you need to. So, once you are done with the database, use the Close method to release the connection. If you don't call this explicitly, the resources will be released when the garbage collector realizes no-one is using the database object any longer; but that relies on something that may not occur for a while.

As you saw with the Query, it returns a collection of objects; each object is made up of properties that match the columns in the query. C#'s support for anonymous objects lets this happen automatically. If you define a class to match your query row result, you can convert the SQL result's anonymous class to your class. This lets you treat the rows in your tables like object instances, and your class can define additional behaviours and checks above the database to control how the values are set. You do have to pull them back out to properties to do an INSERT, but you could choose to write behaviors for your objects that handled that for you.

One thing we have not explored is a multi-table database and joins to reconnect their data; with any sizeable application, your database will end up with several tables related to each other in particular ways. 

[NOTE]
====
ASP.NET provides an automatic object-to-relational mapping called the Entity Framework and an additional language integrated into C# called LINQ for manipulating databases. Those are beyond the scope of this text, but we will walk through it in ASP.NET Extreme.
====

=== Application Database Design

Good database design is a topic in itself, and beyond the scope of this text. Good application database use is a programming design exercise.

You can see a clean example of application-database design in the ASP.NET Identity system and its use in the ASP.NET Web Site with Identity template.

In particular, there is a UserManager class that controls all changes made to the User table, and a User class that holds instances created from rows of the table. Microsoft calls this style of use *Entity Framework*; in the wider general design literature, it is called *Object-Relational Mapping* (ORM), as objects in your application are representations of rows in the table, and the manager for them ensures that changes are made to the underlying table.

UserManager does not expose the SQL it uses, but rather provides the user with specific actions given a User or values that help identify a user, with methods such as:

* FindUserById(username) -- returns the user from the database with the given user name
* FindUserByEmail(email address) -- returns a user given an email address
* DeleteUser(user) -- given a user object, removes it from the underlying table
* ChangeUserPassword(username, oldpassword, newpassword) -- changes the user's password in the object and in the database
* CheckEmail(username, email address) -- returns true if the email address is the one for the user, or false otherwise
* CreateUser (username, email, password, ...) -- creates a new user and puts it into the database

The User class is a simple class with properties for each of the columns in the database.

The UserManager instance also manages connecting to the database. These connections are expensive and must be released when database access completes. In the web universe, this can lead to a lot of churning, since HTTP is a session-less protocol. A typical mature web application will reuse a database connection within the session it thinks it has with a user, but will release it after a certain length without activity, assuming the user has left the web site.

You can ensure that your database connections are closed by cleaning them up by wrapping the connection and database access in a try block with a finally clause. The finally of a try always runs, even if an exception is thrown.

Another way to ensure the connection is closed is to use a C# using statement. This statement ensures that the instance held in its variable declaration is disposed of, no matter how the using block completes.

[source,java]
----
using (var db = Database.Open("PhoneBookDB") ) 
{
    ... SQL operations
}
----

The dispose action will close the database and ensure all resources are released; it invokes the Close operation on the database.

For more information on using, see  https://msdn.microsoft.com/en-us/library/yh598w02.aspx[using Statement (C# Reference, MSDN)]

=== File Handling

Big files such as images can be stored in databases, but often are not. You can receive a file in an HTTP request and write it out to the server's file system; and take a file from the server's file system and include it in a HTTP response.

We are going to look at images and what is particular to them, as they are a common upload/display item on a web page. C#'s file operations include the ability to open and read through text files, and you can find third-party helpers that will display PDF file contents on a page as well.

==== Uploading files

HTML5 forms provide the ability to locate a file and have it sent to the server in a POST request. The operations you need to handle are the server-side storage of the file. Most databases (including SQL Server) have a Binary Large Object (BLOB) data type that could be used to save a file; however, you may want to simply put the file on the server's disk rather than loading it into the database.

[WARNING]
====
When you start allowing file uploads, be aware that file size can cause serious issues in the server (memory use) and on the server's permanent storage. Use caution and set limits to prevent too many uploads or uploads of large files. Also be careful what you do with the file contents -- user files can cause injection attacks if you use their content as HTML or SQL content or allow it to execute in some other fashion on the server.
====

We will walk through the server side code shown in this example:

.ImageUpload.cshtml
[source,html]
----
include::source/ImageUpload.cshtml[]
----

Notice that at the top, I've defined a function isImageFile; I've separate this out as it is a complex check which I may want to expand later to check for image files more thoroughly.

The files in the post are stored in the collection Request.Files; their contents are streamed within the HTTP request (yes, all of them) -- so client-side JavaScript checks for file size would be a very good thing to add.

Before saving the file, we check that it has content and that it is an image file. Once we have that, we look for the actual file name. The full path on the client side is provided in the file's `FileName` property, so we use the static method `Path.GetFileName` to get just the actual file name, stripped of any path above it. Then we create a server-side absolute file name using `Server.MapPath` and providing a target directory, `~/uploads/` and the user's file name.  The `uploads` directory needs to already exist in your project - the first time you will need to create it manually. You could choose a different location - it is not uncommon to store the files in a diretory under `App_Data`; `App_Data` is a protected location, files in it cannot be viewed by users -- attempts will get a 404.8, Not Found, HTTP Response Code.


[TIP]
====
You may, actually, want to make up your own file names on the server -- one user could overwrite another user's files by uploading a file with the same name. This type of file management  requires a database to map users' file names to the file names you've used in the server-side file system.
====

==== Displaying Image Files

To display an image file stored on the server, you actually don't do anything special; it appears in an HTML <img> tag just like any other image.

The tricky part is knowing the file names, if the files were previously uploaded to the server. You might store them in a database, or you might simply browse your image directory on the server to display the files found there.

In our example, we will look in our UploadedFiles directory for files ending in .jpg, .png, or .gif to display on our page.

[source,html]
----
include::source/ImageDisplay.cshtml[]
----

First, you see a helper function, `IsImageFile`, which is similar to our last method. This one checks file extensions, as the file is not embedded in a POST request with a MIME type any longer.

Then in the main body of the page, we use a system class (in the System.IO namespace) Directory. This class contains quite a few methods helpful for listing and traversing directory structures. In particular,

[source,java]
----
Directory.GetFiles(Server.MapPath(@"~/uploads/"));
----

First, you see `Server.MapPath`: that creates a server path, replacing the ~ with the local file system path. So this provides the name of the directory on the server where we expect the files to be. 

The outer call, `Directory.GetFiles` looks in the specified directory for files. It returns an array of file names as strings. These names include the full path to the file.

Once we have the array of files, we can go through it and generate <img> links to the images. First, though, instead of a server filesystem path, we need a URL. This is constructed with the builtin helper `Href`, similar to the `MapPath` call earlier. Notice the special call `Html.AttributeEncode`: that makes sure the attribute values parse correctly. We do this because the original file name may contain characters that cannot be used in an attribute value, such as a ", <, or &. (This also prevents filename-based injection attacks.)



[NOTE]
====
There is a Helper named WebImage -- this helper does a lot of useful activities on images, including resizing, flipping, and watermarking; we could even rewrite our pages to just use WebImage and not HttpPostedFileBase at all. However, we wanted to give you an overview of file handling regardless of file type in this text, so we've used the general form file class.
====

Making files downloadable is very similar to the image display code; enough that we will leave that as an exercise. Instead of generating <img> tags that users can right-click and do "Save As" on, you would generate file names that users could then right-click and do "Save As" on.


==== Deleting Files

If you are doing any sort of file/image upload and saving them as files on the server, you are going to have to do some mop-up operations at some point, to remove files. You may, for example, be storing a profile image for a user, and then when it is updated, you need to delete the old image and save the new one.

.ImageDelete.cshtml
[source,java]
----
include::source/ImageDelete.cshtml[]
----
For our delete page, we've listed all of the files with radiobuttons; one is chosen, and when the Submit button is pressed, it is deleted. You see many of the same calls we've made in our other pages: Server.MapPath to get the file server path; Directory.GetFiles to list all of the files; and Html.AttributeEncode to protext the attribute value. You will notice that we used Html.Encode on the value next to the radio button, again to prevent an injection attack through file names.

The other new calls you will notice are File.Exists and File.Delete; these look at the local filesystem to see if the file exists, and to remove it. 

[WARNING]
====
When you write code that changes files on the server disk, consider it very carefully, and think through the potential ways your code or system could be attack. Consider the impact of a flood of requests; of large files; of files with malicious content; of file names. Protect carefully access to files shared among all of your users. Think about the models on the internet: the user who installs a file typically has the right to remove it, while other users may see it but not modify it. To implement such a system, we will need to add user accounts, which we will look at in the next chapter.
====

==== WebImage Helper

If you are only uploading and displaying image files, there is a helper tailored to images, `WebImage`. This is described in https://msdn.microsoft.com/en-us/library/system.web.helpers.webimage(v=vs.111).aspx.
In addition to basic file information, this allows you to create images from an array of bytes, and to flip, watermark, or resize an image. It is used in the MSDN tutorial http://www.asp.net/web-pages/overview/ui-layouts-and-themes/9-working-with-images.


==== Deployment and file management

If you are using a PaaS such as AppHarbor, check its file management policy; many limit where files can be uploaded to, and may not keep files persistently -- they may disappear when your app cycles off of their server, and in complex scenarios may disappear mid-way due to your app getting relocated within their server farm.


=== Further Reading

* https://msdn.microsoft.com/en-us/library/webmatrix.data.database(v=vs.111).aspx
* http://www.asp.net/web-pages/overview/getting-started/introducing-aspnet-web-pages-2/form-basics
* http://www.asp.net/web-pages/overview/getting-started/introducing-aspnet-web-pages-2/entering-data
* http://www.asp.net/web-pages/overview/data/5-working-with-data
* http://www.mikesdotnetting.com/article/214/how-to-check-if-a-query-returns-data-in-asp-net-web-pages
* http://www.mikesdotnetting.com/article/211/adding-a-footer-to-the-razor-webgrid
* http://www.asp.net/web-pages/overview/data/working-with-files
* http://www.asp.net/web-pages/overview/ui-layouts-and-themes/9-working-with-images
* http://suika.fam.cx/www/manakai-core/lib/Whatpm/ContentType.html
* http://www.hanselman.com/blog/ABackToBasicsCaseStudyImplementingHTTPFileUploadWithASPNETMVCIncludingTestsAndMocks.aspx 
* https://msdn.microsoft.com/en-us/library/system.io.path(v=vs.110).aspx
* https://msdn.microsoft.com/en-us/library/system.guid.newguid(v=vs.110).aspx
* https://msdn.microsoft.com/en-us/library/gg427611.aspx
// * http://www.asp.net/web-pages/overview/ui-layouts-and-themes/displaying-maps-in-an-aspnet-web-pages-site

=== Exercises

. Build a 4-page phone book application that combines databases and images: start with PhoneBookDB and its 4 pages, and enable uploading images when adding an entry.  The database row should record the image file name so that you know how to find it, or a null if there is no image. This will require adding a column to the table.
+
Once you have that working, update it so that when images are uploaded, don't use the original file name; generate a unique name using
the system class `Guid` (GUID is Globally Unique Identifier) like so:
+
[source,java]
----
 string g = Guid.NewGuid().ToString();
----
+
You will need to save and append the original file's file extension on the guid; `Path.GetExtension` will provide this information.
+
Save both the original file name and the GUID-based file name in the database (yes, another column in the table is needed) so that you can display the user's file name to them rather than the internal, server-side GUID-based name.
+
When you display the full record (on the Update page) show the current image and give the user the ability to replace it. The replace should delete the old file and save the new one.
+
Modify the site to have a common layout and appearance using _SiteLayout.cshtml and _PageStart.cshtml.

. Rewrite the word-guessing page from the exercises in the chapter <<methodsclassesobjects,C# Methods, Classes, and Objects>>. Have the words stored in a database, so that you don't have to generate an array on every load of the page, but rather access the database to see the list of words.
+
Move out common look and feel portions of the page to a _SiteLayout.cshtml file and then add an administrative panel that also uses that layout. The Administrative panel for your game should, in one page (not 4 separate pages) let you add, remove, or alter words all on the same page; this is a design exercise, so consider how you would go about it in a way that fits our word list and is clear to the user how to add, remove, or modify words.

. One common activity on websites is to upload files and have them analyzed. Write a web page that requests a text file upload, then performs a word count of the contents. Save the file locally as a GUID and delete it once the count is completed. See http://www.asp.net/web-pages/overview/data/working-with-files for examples of how to read files and split up their lines and words.
+
What other analysis might you do? think of one, write a specification for it, and implement it. This is an exercise in writing a precise-enough specification, and then implement it. Consider if you need to add more detail to the specification if you were not the implementer, but had to hand it over to someone else to implement.
+
This exercise uses two skills from this chapter, collections and File I/O. Get comfortable with the power of the foreach loop with collections, and with the variety of methods and properties on File I/O.

. Suppose that the user gives you a file contains information about sales 
figures for a company in various cities.
Each line of the file contains a city name, followed by a colon (:) followed by the data for that
city.  The data is a number of type double.
However, for some cities, no data was available.  In these lines, the data is replaced by
a comment explaining why the data is missing.  For example, several lines from the file might
look like:
+
[source,java]
----
San Francisco:  19887.32
Chicago:  no report received
New York: 298734.12
----
+
Write a program that will compute and print the total sales from all the cities together. The
program should also report the number of cities for which data was not available.  The name of the
file is "sales.dat".
+
To complete this program, you'll need to save the file locally, then open the file and read from it. C# provides a convenient File method `ReadAllLines` that ties file reading into collections. The method `File.ReadAllLines` opens a file and makes all of the lines available as an IEnumerable<string>. This means you can use a foreach loop to look at each line in turn, and know that when it completes, you have reached the end of the file.
+
Suggestion:  For each line, split it on the colon into two strings using Split with the ':' character.
See if the second string is a valid number with IsDouble(), and convert it with AsDouble().
+
The file class has all of the methods you need to read the file; see https://msdn.microsoft.com/en-us/library/system.io.file(v=vs.110).aspx[the .NET Class specification]. Notice that `ReadAllLines` opens the file, reads all of the lines, and closes it. This does use alot of memory, since the file's contents are held in memory.
+
Remember to use iterative development; you might expand the pseudocode above into pseudocode containing the processing of the lines. Make small changes to your code so that when you hit a problem, you have only a few things to look at to determine the cause.
+
How might you process the file if it was too large to hold in memory? Add a check of the file size before opening it, and only uses your solution for small files. What do you think the line between large and small should be?
+
Challenge: Implement an alternative solution for large files that avoids bringing the file into memory at one time; this is complex, as it requires reading from the file a byte or chunk at a time, processing that, and then continuing.

. Develop a web application that provides you with a file server. It should:
+
* list the directory structure and files on the server under some "root" upload location
* let you create or remove a directory there
* let you upload a file to a particular remote directory
* let you download a file from a particular remote directory
* let you delete a previously uploaded file
+
To make this task manageable, start with just uploading/downloading/listing remote files in a single directory, and then add directory management as a second exercise.
+
This isn't very secure, since anyone with the web page can access all of these files; in a future chapter, you will add user management, so each user has their own file server. Consider how you might make this file server specific to one user, perhaps with a root directory that is a GUID specific to that user; the user should not need to know the GUID to use their files.

=== Project

This chapter represents a huge step forward: you can now make your data persistent, and provide users with the ability to alter it, whether that is through the direct 4-page "CRUD" style or more indirect, as actions taken when they move around your website.

Add a persistent backing store to your project, replacing any hard-coded arrays with database accesses.
